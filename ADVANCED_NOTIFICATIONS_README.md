# ๐ ูุธุงู ุงูุฅุดุนุงุฑุงุช ุงููุชุทูุฑ - ุชุทุจูู ูุชุฑู

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุชุทููุฑ ูุธุงู ุฅุดุนุงุฑุงุช ุดุงูู ููุชุทูุฑ ูุชุทุจูู ูุชุฑู ูุฏุนู:
- ุฅุดุนุงุฑุงุช ุชููุงุฆูุฉ ุนูุฏ ุชุบููุฑ ุญุงูุฉ ุงูุจูุงุบุงุช
- ุฅุดุนุงุฑุงุช ุชุนููู ุงููุญูููู
- ููุงูุจ ุฅุดุนุงุฑุงุช ุงุญุชุฑุงููุฉ ุจุงููุบุฉ ุงูุนุฑุจูุฉ
- ุฏุนู FCM ููุฅุดุนุงุฑุงุช ุงูููุฑูุฉ
- ุชูุงูู ูุงูู ูุน Supabase Edge Functions

## โ ุงููููุฒุงุช ุงููููุฌุฒุฉ

### 1. **ูุธุงู FCM Token Management** ๐
- ุชุณุฌูู ุชููุงุฆู ูู FCM Tokens ุนูุฏ ุชุณุฌูู ุงูุฏุฎูู
- ุฏุนู ุฃุฌูุฒุฉ ูุชุนุฏุฏุฉ ูููุณ ุงููุณุชุฎุฏู
- ุชูุธูู ุชููุงุฆู ููุฑููุฒ ุงููุฏููุฉ ูุบูุฑ ุงููุดุทุฉ
- ุฏูุงู Upsert ูุญุณูุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

### 2. **ุฅุดุนุงุฑุงุช ุชุบููุฑ ุญุงูุฉ ุงูุจูุงุบุงุช** ๐
ุนูุฏูุง ูููู ุงููุณุคูู ุจุชุญุฏูุซ ุญุงูุฉ ุงูุจูุงุบุ ูุชู ุฅุฑุณุงู ุฅุดุนุงุฑ ุชููุงุฆู ูููุจูุบ ุญุณุจ ุงูุญุงูุฉ:

#### ุงูุญุงูุงุช ุงููุฏุนููุฉ:
- **๐ฉ ุชู ุงูุงุณุชูุงู (received)**: ุฅุดุนุงุฑ ุจุชุฃููุฏ ุงุณุชูุงู ุงูุจูุงุบ
- **๐ ููุฏ ุงูุชุญููู (under_investigation)**: ุฅุดุนุงุฑ ุจุจุฏุก ุงูุชุญููู
- **โ ุชู ุงูุญู (resolved)**: ุฅุดุนุงุฑ ุจุญู ุงูุจูุงุบ ุจูุฌุงุญ
- **โ ูุฑููุถ (rejected)**: ุฅุดุนุงุฑ ุจุฑูุถ ุงูุจูุงุบ ูุน ุงูุฃุณุจุงุจ
- **๐ ููุบูู (closed)**: ุฅุดุนุงุฑ ุจุฅุบูุงู ุงูุจูุงุบ ููุงุฆูุงู
- **โณ ูู ุงูุงูุชุธุงุฑ (pending)**: ุฅุดุนุงุฑ ุจูุถุน ุงูุจูุงุบ ูู ูุงุฆูุฉ ุงูุงูุชุธุงุฑ

### 3. **ุฅุดุนุงุฑุงุช ุชุนููู ุงููุญูููู** ๐จโ๐ผ
- ุฅุดุนุงุฑ ูููุจูุบ ุนูุฏ ุชุนููู ูุญูู ููุถูุชู
- ุฅุดุนุงุฑ ูููุญูู ุนูุฏ ุชููููู ุจูุถูุฉ ุฌุฏูุฏุฉ
- ูุนูููุงุช ุดุงููุฉ ุนู ุงููุถูุฉ ูุงูุฃููููุฉ

### 4. **Edge Function ูุญุณูุฉ** ๐
ุชู ุฅูุดุงุก `send-bulk-notifications` Edge Function ุฌุฏูุฏุฉ ุชุฏุนู:
- ุฅุฑุณุงู FCM ุญูููู (ููุณ ูุญุงูุงุฉ)
- ุฏุนู ุฃููุงุน ุฅุดุนุงุฑุงุช ูุชุนุฏุฏุฉ
- ุชุณุฌูู ููุตู ููุฃุฎุทุงุก ูุงููุฌุงุญุงุช
- ุชุญุฏูุซ ุญุงูุฉ ุงูุฅุดุนุงุฑุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

### 5. **ููุงูุจ ุฅุดุนุงุฑุงุช ุงุญุชุฑุงููุฉ** ๐จ
ุฎุฏูุฉ `NotificationTemplateService` ุชููุฑ:
- ููุงูุจ ุงุญุชุฑุงููุฉ ุจุงููุบุฉ ุงูุนุฑุจูุฉ
- ุฑุณุงุฆู ููุตูุฉ ููููุฏุฉ ูููุณุชุฎุฏู
- ุฏุนู ุงููุนูููุงุช ุงูุฅุถุงููุฉ (ุงุณู ุงููุญููุ ุงูููุช ุงููุชููุนุ ุฅูุฎ)
- ุฅูููุฌู ููุงุณุจุฉ ููู ููุน ุฅุดุนุงุฑ

### 6. **ูุนุงูุฌุฉ ุงูุฅุดุนุงุฑุงุช ุงููุงุฑุฏุฉ** ๐ฑ
ุชุญุณูู `NotificationService` ูุฏุนู:
- ุงูุชูุฌูู ุงูุชููุงุฆู ููุตูุญุฉ ุงูููุงุณุจุฉ ุนูุฏ ุงูููุฑ ุนูู ุงูุฅุดุนุงุฑ
- ุฏุนู ุฃููุงุน ุฅุดุนุงุฑุงุช ูุชุนุฏุฏุฉ
- ุชุณุฌูู ููุตู ููุชููู ูุงูุฃุฎุทุงุก

## ๐ง ุงูุฅุนุฏุงุฏ ูุงูุชูููู

### 1. ูุชุทูุจุงุช Supabase

#### ูุงุนุฏุฉ ุงูุจูุงูุงุช:
ุชุฃูุฏ ูู ูุฌูุฏ ุงูุฌุฏุงูู ุงูุชุงููุฉ:
```sql
-- ุฌุฏูู ุงููุณุชุฎุฏููู
users (id, first_name, last_name, user_type, ...)

-- ุฌุฏูู ุงูุจูุงุบุงุช
reports (id, user_id, reporter_first_name, reporter_last_name, case_number, ...)

-- ุฌุฏูู ุงูุฅุดุนุงุฑุงุช
notifications (id, user_id, title, body, notification_type, ...)

-- ุฌุฏูู ุฑููุฒ FCM
user_fcm_tokens (id, user_id, fcm_token, device_type, is_active, ...)
```

#### Edge Functions:
1. **ุชูุนูู `send-bulk-notifications` Function**:
```bash
supabase functions deploy send-bulk-notifications
```

2. **ุชุนููู ูุชุบูุฑุงุช ุงูุจูุฆุฉ**:
```bash
supabase secrets set FCM_SERVER_KEY=your_fcm_server_key
```

### 2. ุฅุนุฏุงุฏ Firebase

#### ุงูุญุตูู ุนูู FCM Server Key:
1. ุงุฐูุจ ุฅูู Firebase Console
2. ุงุฎุชุฑ ูุดุฑูุนู
3. Settings โ Cloud Messaging
4. ุงูุณุฎ Server Key ูุฃุถูู ูู Supabase Secrets

### 3. ุชูุนูู ุงูุฅุดุนุงุฑุงุช ูู ุงูุชุทุจูู

#### ูู `main.dart`:
```dart
await NotificationService().init();
await SimpleFcmService().init();
```

## ๐ ููููุฉ ุงูุงุณุชุฎุฏุงู

### 1. ุฅุฑุณุงู ุฅุดุนุงุฑ ุนูุฏ ุชุบููุฑ ุญุงูุฉ ุงูุจูุงุบ

ูุชู ุชููุงุฆูุงู ุนูุฏ ุงุณุชุฏุนุงุก:
```dart
adminReportDataSource.updateReportStatus(
  reportId: "report_id",
  status: "resolved", // ุฃู ุญุงูุฉ ูู ุงูุญุงูุงุช ุงููุฏุนููุฉ
  notes: "ุชู ุญู ุงููุดููุฉ ุจูุฌุงุญ",
);
```

### 2. ุฅุฑุณุงู ุฅุดุนุงุฑ ุนูุฏ ุชุนููู ูุญูู

ูุชู ุชููุงุฆูุงู ุนูุฏ ุงุณุชุฏุนุงุก:
```dart
adminReportDataSource.assignReport(
  reportId: "report_id",
  investigatorId: "investigator_id",
  notes: "ุชู ุชุนููู ุงููุญูู ุฃุญูุฏ ูุญูุฏ",
);
```

### 3. ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ูุฌูุนุฉ ูุฏููุฉ

```dart
await edgeFunctionsService.sendBulkNotifications(
  userIds: ["user1", "user2", "user3"],
  title: "ุฅุดุนุงุฑ ุนุงู ููู",
  body: "ุฑุณุงูุฉ ุงูุฅุดุนุงุฑ ููุง",
  data: {
    "type": "general",
    "action": "view_announcement",
  },
);
```

### 4. ุงุณุชุฎุฏุงู ููุงูุจ ุงูุฅุดุนุงุฑุงุช ุงููุชูุฏูุฉ

```dart
// ูุงูุจ ุชุฑุญูุจ ุจูุณุชุฎุฏู ุฌุฏูุฏ
final welcomeTemplate = NotificationTemplateService.welcomeUser(
  userName: "ุฃุญูุฏ ูุญูุฏ",
  userType: "citizen",
);

// ูุงูุจ ุชูุจูู ุฃููู
final securityTemplate = NotificationTemplateService.securityAlert(
  alertType: "emergency",
  location: "ุดุงุฑุน ุงูุชุญุฑูุฑุ ูุณุท ุงูุจูุฏ",
  severity: "ุนุงูู",
  description: "ุญุงุฏุซ ูุฑูุฑู ูุจูุฑ",
);
```

## ๐งช ุงุฎุชุจุงุฑ ุงููุธุงู

### 1. ุงุฎุชุจุงุฑ FCM Token Registration:
```dart
final token = await SimpleFcmService().getFcmTokenAndRegister();
print("FCM Token: $token");
```

### 2. ุงุฎุชุจุงุฑ ุฅุฑุณุงู ุฅุดุนุงุฑ ุชุฌุฑูุจู:
```bash
curl -X POST 'https://yesjtlgciywmwrdpjqsr.supabase.co/functions/v1/send-bulk-notifications' \
  -H 'Authorization: Bearer YOUR_ACCESS_TOKEN' \
  -H 'Content-Type: application/json' \
  -d '{
    "userIds": ["user_id_here"],
    "title": "ุงุฎุชุจุงุฑ ุงูุฅุดุนุงุฑ",
    "body": "ูุฐุง ุฅุดุนุงุฑ ุชุฌุฑูุจู",
    "notificationType": "general"
  }'
```

### 3. ูุฑุงูุจุฉ ุงูุณุฌูุงุช:
- ุฑุงูุจ ุณุฌูุงุช Edge Functions ูู Supabase Dashboard
- ุฑุงูุจ ุณุฌูุงุช ุงูุชุทุจูู ููุชุฃูุฏ ูู ุชุณุฌูู FCM Tokens
- ุชุญูู ูู ุฌุฏูู `notifications` ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ูุดุงูู ุดุงุฆุนุฉ ูุญููููุง:

#### 1. FCM Tokens ุบูุฑ ูุณุฌูุฉ:
```dart
// ุชุญูู ูู ุฅุนุฏุงุฏุงุช ุงูุฃุฐููุงุช
final hasPermission = await NotificationService().requestNotificationPermissions();
if (!hasPermission) {
  // ุงุทูุจ ูู ุงููุณุชุฎุฏู ุชูุนูู ุงูุฅุดุนุงุฑุงุช ูู ุฅุนุฏุงุฏุงุช ุงููุธุงู
}
```

#### 2. ุฅุดุนุงุฑุงุช ูุง ุชุตู:
- ุชุฃูุฏ ูู ูุฌูุฏ FCM_SERVER_KEY ูู Supabase Secrets
- ุชุญูู ูู ุตุญุฉ FCM Tokens ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ุฑุงุฌุน ุณุฌูุงุช Edge Function ููุฃุฎุทุงุก

#### 3. ูุดุงูู ูู ุงูุชูุฌูู ุนูุฏ ุงูููุฑ:
```dart
// ุชุฃูุฏ ูู ูุฌูุฏ ุงูุจูุงูุงุช ุงูุตุญูุญุฉ ูู payload ุงูุฅุดุนุงุฑ
data: {
  "type": "report_status_update",
  "report_id": "actual_report_id",
  "navigation_route": "/report_details",
}
```

## ๐ ุงูุชุทููุฑุงุช ุงููุณุชูุจููุฉ

### ุงูููุฒุงุช ุงูููุชุฑุญุฉ:
1. **ุฅุดุนุงุฑุงุช ูุฌุฏููุฉ**: ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ูู ุฃููุงุช ูุญุฏุฏุฉ
2. **ุฅุดุนุงุฑุงุช ุฌูุงุนูุฉ ูุชูุฏูุฉ**: ุญุณุจ ุงููููุน ุงูุฌุบุฑุงูู ุฃู ุงููุญุงูุธุฉ
3. **ููุงูุจ ุฅุดุนุงุฑุงุช ูุงุจูุฉ ููุชุฎุตูุต**: ูู ููุญุฉ ุงูุชุญูู
4. **ุฅุญุตุงุฆูุงุช ุงูุฅุดุนุงุฑุงุช**: ูุนุฏูุงุช ุงููุชุญ ูุงูุชูุงุนู
5. **ุฅุดุนุงุฑุงุช ุตูุชูุฉ**: ููุญุงูุงุช ุงูุนุงุฌูุฉ

### ุชุญุณููุงุช ุชูููุฉ:
1. **Retry Logic**: ุฅุนุงุฏุฉ ุงููุญุงููุฉ ููุฅุดุนุงุฑุงุช ุงููุงุดูุฉ
2. **Rate Limiting**: ููุน ุงูุฅุฑุณุงู ุงูููุฑุท
3. **A/B Testing**: ุงุฎุชุจุงุฑ ุฃููุงุน ุฑุณุงุฆู ูุฎุชููุฉ
4. **Analytics Integration**: ุฑุจุท ูุน Google Analytics

## ๐ ุงูุฏุนู

ูุฃู ูุณุงุนุฏุฉ ุฃู ุงุณุชูุณุงุฑุงุช:
1. ุฑุงุฌุน ุงูุณุฌูุงุช ูู Supabase Dashboard
2. ุชุญูู ูู ุฌุฏุงูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุทููุจุฉ
3. ุชุฃูุฏ ูู ุฅุนุฏุงุฏ FCM ุจุดูู ุตุญูุญ
4. ุงุฎุชุจุฑ Edge Functions ูู ุฎูุงู Supabase CLI

---

**ููุงุญุธุฉ**: ูุฐุง ุงููุธุงู ุฌุงูุฒ ููุงุณุชุฎุฏุงู ุงูููุฑู! ููุท ุชุฃูุฏ ูู ุฅุนุฏุงุฏ FCM_SERVER_KEY ูู Supabase Secrets ููู ุดูุก ุณูุนูู ุจุณูุงุณุฉ! ๐
import 'dart:developer';

import 'package:dio/dio.dart';

import '../../domain/entities/chat_message_entity.dart';
import '../models/chat_message_model.dart';

abstract class ChatbotRemoteDataSource {
  /// Send message to chatbot API and get response
  Future<ChatMessageModel> sendMessage({
    required String message,
    required String sessionId,
    Map<String, dynamic>? context,
  });

  /// Get help menu content
  Future<String> getHelpMenu();

  /// Get law information by category
  Future<String> getLawInfo(String category);

  /// Check if message context is allowed
  Future<bool> isContextAllowed(String message);
}

class ChatbotRemoteDataSourceImpl implements ChatbotRemoteDataSource {
  final Dio dio;
  final String groqApiKey;
  final String baseUrl = 'https://api.groq.com/openai/v1/chat/completions';

  ChatbotRemoteDataSourceImpl({required this.dio, required this.groqApiKey});

  @override
  Future<ChatMessageModel> sendMessage({
    required String message,
    required String sessionId,
    Map<String, dynamic>? context,
  }) async {
    try {
      log('๐ ุฅุฑุณุงู ุฑุณุงูุฉ ุฅูู Groq API: $message');

      // Create a specialized Dio instance for Groq API
      final groqDio = Dio();
      groqDio.options.headers = {
        'Authorization': 'Bearer $groqApiKey',
        'Content-Type': 'application/json',
      };

      final requestBody = {
        'model': 'llama-3.1-8b-instant',
        'messages': [
          {'role': 'system', 'content': _getSystemPrompt()},
          {'role': 'user', 'content': message},
        ],
        'temperature': 0.2,
        'max_tokens': 1000,
      };

      log('๐ค ุฅุฑุณุงู ุงูุทูุจ ุฅูู: $baseUrl');
      final response = await groqDio.post(baseUrl, data: requestBody);
      log('๐ฅ ุญุงูุฉ ุงูุงุณุชุฌุงุจุฉ: ${response.statusCode}');

      if (response.statusCode == 200) {
        final data = response.data;
        log('โ ุชู ุงูุญุตูู ุนูู ุงูุงุณุชุฌุงุจุฉ ุจูุฌุงุญ');

        final content = data['choices'][0]['message']['content'] as String;
        log('๐ ูุญุชูู ุงูุงุณุชุฌุงุจุฉ: ${content.substring(0, 100)}...');

        // Clean the content from markdown formatting
        final cleanContent = _cleanMarkdownText(content);

        final category = _determineCategory(message, cleanContent);

        final result = ChatMessageModel.assistantMessage(
          id: '${DateTime.now().millisecondsSinceEpoch}',
          content: cleanContent,
          category: category,
          metadata: {
            'sessionId': sessionId,
            'model': 'llama-3.1-8b-instant',
            'timestamp': DateTime.now().toIso8601String(),
          },
        );
        log('โ ChatMessageModel ุชู ุฅูุดุงุคู ุจูุฌุงุญ: ${result.id}');
        return result;
      } else {
        log('โ ูุดู API call: ${response.statusCode}');
        throw Exception('API call failed: ${response.statusCode}');
      }
    } catch (e) {
      log('๐ฅ ุฎุทุฃ ูู sendMessage: $e');
      throw Exception('ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงููุณุงุนุฏ ุงูุฐูู: $e');
    }
  }

  /// Clean markdown formatting from text and fix UTF-16 issues
  String _cleanMarkdownText(String text) {
    String cleanText = text;

    // Fix UTF-16 issues by removing invalid characters
    cleanText = _sanitizeUtf16(cleanText);

    // Remove markdown headers (# ## ###)
    cleanText = cleanText.replaceAll(RegExp(r'#{1,6}\s*'), '');

    // Remove bold and italic formatting (** * __)
    cleanText = cleanText.replaceAll(RegExp(r'\*\*([^*]+)\*\*'), r'$1');
    cleanText = cleanText.replaceAll(RegExp(r'\*([^*]+)\*'), r'$1');
    cleanText = cleanText.replaceAll(RegExp(r'__([^_]+)__'), r'$1');
    cleanText = cleanText.replaceAll(RegExp(r'_([^_]+)_'), r'$1');

    // Remove table formatting (| characters and table separators)
    cleanText = cleanText.replaceAll(RegExp(r'\|'), '');

    // Remove code blocks (``` and inline `code`)
    cleanText = cleanText.replaceAll(RegExp(r'```[^`]*```', dotAll: true), '');
    cleanText = cleanText.replaceAll(RegExp(r'`([^`]+)`'), r'$1');

    // Remove bullet points and list formatting
    cleanText = cleanText.replaceAll(
      RegExp(r'^\s*[-*+โข]\s*', multiLine: true),
      '',
    );
    cleanText = cleanText.replaceAll(
      RegExp(r'^\s*\d+\.\s*', multiLine: true),
      '',
    );

    // Remove $1, $2, etc. placeholders (regex replacement artifacts)
    cleanText = cleanText.replaceAll(RegExp(r'\$\d+'), '');

    // Remove any remaining asterisks and special characters
    cleanText = cleanText.replaceAll(RegExp(r'[\*#_`~\[\]]'), '');

    // Remove HTML tags if any
    cleanText = cleanText.replaceAll(RegExp(r'<[^>]*>'), '');

    // Clean up multiple consecutive spaces and newlines
    cleanText = cleanText.replaceAll(RegExp(r'\n\s*\n\s*\n+'), '\n\n');
    cleanText = cleanText.replaceAll(RegExp(r'[ \t]+'), ' ');
    cleanText = cleanText.replaceAll(RegExp(r'\n[ \t]+'), '\n');

    // Remove leading/trailing whitespace from each line
    List<String> lines = cleanText.split('\n');
    lines = lines.map((line) => line.trim()).toList();
    cleanText = lines.join('\n');

    // Remove empty lines at the beginning and end
    cleanText = cleanText.trim();

    return cleanText;
  }

  /// Sanitize text to fix UTF-16 issues
  String _sanitizeUtf16(String text) {
    try {
      // Remove invalid UTF-16 characters
      final sanitized = text.runes
          .where((rune) => rune != 0xFFFD && rune <= 0x10FFFF)
          .map((rune) => String.fromCharCode(rune))
          .join('');
      
      // Remove any problematic emojis or characters that might cause issues
      return sanitized
          .replaceAll(RegExp(r'[\uD800-\uDFFF]'), '') // Remove surrogate pairs
          .replaceAll(RegExp(r'[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x9F]'), '') // Remove control characters
          .trim();
    } catch (e) {
      log('โ๏ธ ุฎุทุฃ ูู ุชูุธูู ุงููุต: $e');
      return text.replaceAll(RegExp(r'[^\x20-\x7E\u0600-\u06FF\u0750-\u077F]'), '');
    }
  }

  @override
  Future<String> getHelpMenu() async {
    // This could be served from local storage or a simple API call
    return '''ูุงุฆูุฉ ุงููุณุงุนุฏุฉ - ุชุทุจูู ูุชุฑู ูุงูููุงููู ุงููุตุฑูุฉ:

๐ฑ ูุนูููุงุช ุงูุชุทุจูู:
โข ูุง ูู ุชุทุจูู ูุชุฑูุ
โข ูููุฒุงุช ูุฅููุงููุงุช ุงูุชุทุจูู
โข ุงูุชูููุงุช ุงููุณุชุฎุฏูุฉ
โข ุงูุฃูุงู ูุงูุฎุตูุตูุฉ

๐ค ุงููุณุงุนุฏ ุงูุฐูู ุณูุจูู:
โข ุฅููุงููุงุช ุงููุณุงุนุฏ ุงูุฐูู
โข ููููุฉ ุงููุณุงุนุฏุฉ ูู ุงูุจูุงุบุงุช

๐บ๏ธ ุงูุฎุฑูุทุฉ ุงูุญุฑุงุฑูุฉ:
โข ุดุฑุญ ุงูุฎุฑูุทุฉ ุงูุชูุงุนููุฉ
โข ูุณุชููุงุช ุงูุฃูุงู ูู ุงูููุงุทู

โ๏ธ ุงูููุงููู ุงููุตุฑูุฉ:
โข ูุงููู ุงูุนููุจุงุช (ุงูุณุฑูุฉุ ุงูุงุนุชุฏุงุกุ ุงูุชุญุฑุดุ ุงูุนูู ุงูููุฒูู)
โข ูุงููู ุงููุฎุฏุฑุงุช
โข ูุงููู ุงููุฑูุฑ ูุงูุญูุงุฏุซ
โข ูุงููู ุญูุงูุฉ ุงูุจูุงูุงุช ุงูุดุฎุตูุฉ
โข ูุงููู ููุงูุญุฉ ุงูุฌุฑุงุฆู ุงูุฅููุชุฑูููุฉ
โข ูุงุฌุจุงุช ุงูุฅุจูุงุบ ูุงูุญูุงูุฉ ุงููุงููููุฉ

๐จ ุฃููุงุน ุงูุจูุงุบุงุช:
โข ุงูุฌุฑุงุฆู ุงูุฌูุงุฆูุฉ ูุงููุฑูุฑูุฉ
โข ุงูุทูุงุฑุฆ ุงูุทุจูุฉ ูุงูุญุฑุงุฆู
โข ุงูุชุญุฑุด ูุงูุนูู ุงูููุฒูู
โข ุงููุฎุฏุฑุงุช ูุงูุฌุฑุงุฆู ุงูุฅููุชุฑูููุฉ

ุงูุชุจ ุณุคุงูู ุฃู ุงุฎุชุฑ ูู ุงูููุงุถูุน ุฃุนูุงู!''';
  }

  @override
  Future<String> getLawInfo(String category) async {
    switch (category.toLowerCase()) {
      case 'ุฌูุงุฆู':
      case 'ุนููุจุงุช':
        return '''ูุงููู ุงูุนููุจุงุช ุงููุตุฑู:

ุงูุณุฑูุฉ - ุงูููุงุฏ 311-317 ูู ูุงููู ุงูุนููุจุงุช:
ุชุนุฑูู ุงูุณุฑูุฉ: ูู ุฃุฎุฐ ูุงู ููููู ููููู ููุบูุฑ ุจุบูุฑ ุฑุถุงู ูุจูุตุฏ ุชูููู ููุงุฆูุงู.

ุงูุนููุจุงุช ุงูููุฑุฑุฉ:
โข ุงูุณุฑูุฉ ุงูุจุณูุทุฉ: ุงูุญุจุณ ูู 6 ุฃุดูุฑ ุฅูู ุณูุชูู ุฃู ุบุฑุงูุฉ ูู 200 ุฅูู 500 ุฌููู ูุตุฑู
โข ุงูุณุฑูุฉ ูู ุงูููุงุฒู: ุงูุญุจุณ ูุน ุงูุดุบู ูู ุณูุฉ ุฅูู 7 ุณููุงุช
โข ุงูุณุฑูุฉ ุจุงูุฅูุฑุงู (ุงูุณุทู): ุงูุฃุดุบุงู ุงูุดุงูุฉ ุงููุคุจุฏุฉ ุฃู ุงููุคูุชุฉ ูู 10 ุฅูู 15 ุณูุฉ
โข ุงูุณุฑูุฉ ูู ุงูููู: ุนููุจุฉ ูุดุฏุฏุฉ ุชุตู ุฅูู ุงูุฃุดุบุงู ุงูุดุงูุฉ
โข ุงูุณุฑูุฉ ูู ูุณุงุฆู ุงูููู: ุงูุญุจุณ ูู ุณูุฉ ุฅูู 7 ุณููุงุช

ุงูุธุฑูู ุงููุดุฏุฏุฉ:
- ุฅุฐุง ูุงูุช ุงูุณุฑูุฉ ูู ููุงู ูุณููู ุฃู ูุนุฏ ููุณูู
- ุฅุฐุง ูุงูุช ุจูุณุฑ ุฃู ุชุณูู ุฃู ุงุณุชุนูุงู ููุงุชูุญ ูุตุทูุนุฉ
- ุฅุฐุง ููุนุช ูู ุดุฎุตูู ูุฃูุซุฑ
- ุฅุฐุง ูุงู ุงูุฌุงูู ูุญูู ุณูุงุญุงู

ุงูุงุนุชุฏุงุก - ุงูููุงุฏ 240-244 ูู ูุงููู ุงูุนููุจุงุช:
ูุดูู ุงูุงุนุชุฏุงุก ุนูู ุณูุงูุฉ ุงูุฌุณู ุฃู ุฅูุญุงู ุฃุฐู ุฌุณุฏู ุฃู ูุนููู ุจุงูุขุฎุฑูู.

ุฃููุงุน ุงูุงุนุชุฏุงุก ูุงูุนููุจุงุช:
โข ุงูุถุฑุจ ุงูุจุณูุท: ุงูุญุจุณ ูู ุดูุฑ ุฅูู ุณูุชูู ูุบุฑุงูุฉ ูู 200 ุฅูู 1000 ุฌููู
โข ุงูุฅูุฐุงุก ุงูุนูุฏ: ุงูุญุจุณ ูู 6 ุฃุดูุฑ ุฅูู 3 ุณููุงุช ุฅุฐุง ูุชุฌ ุนูู ูุฑุถ ุฃู ุนุฌุฒ ุนู ุงูุนูู ูุฃูุซุฑ ูู 20 ูููุงู
โข ุงูุฌุฑุญ ุงูุนูุฏ: ุงูุญุจุณ ูู ุณูุฉ ุฅูู 5 ุณููุงุช ุฅุฐุง ุงุณุชุนูู ุขูุฉ ุญุงุฏุฉ ุฃู ุฑุงุถุฉ
โข ุงูุฅูุฐุงุก ุงูููุถู ุฅูู ุงูููุช: ุงูุฃุดุบุงู ุงูุดุงูุฉ ูู 3 ุฅูู 7 ุณููุงุช
โข ุงูุงุนุชุฏุงุก ุนูู ุงูููุธููู: ุนููุจุฉ ูุดุฏุฏุฉ ุชุตู ุฅูู ุงูุฃุดุบุงู ุงูุดุงูุฉ

ุงูุธุฑูู ุงููุดุฏุฏุฉ:
- ุฅุฐุง ูุงู ุงููุฌูู ุนููู ูู ุฃุตูู ุงูุฌุงูู ุฃู ูุฑูุนู
- ุฅุฐุง ูุงู ุงูุงุนุชุฏุงุก ุนูู ููุธู ุนุงู ุฃุซูุงุก ุชุฃุฏูุฉ ูุธููุชู
- ุฅุฐุง ูุงู ุงูุงุนุชุฏุงุก ุจุณุจุจ ุงูุฏูู ุฃู ุงูุนููุฏุฉ ุฃู ุงูุฌูุณ

๐ก ุชุทุจูู ูุชุฑู ูุฏุนู ุงูุฅุจูุงุบ ุงูููุฑู ุนู ุฌููุน ุฃููุงุน ุงูุณุฑูุฉ ูุงูุงุนุชุฏุงุก ูุน ุฅููุงููุฉ ุฑูุน ุงูุฃุฏูุฉ ูุงูุตูุฑ.''';

      case 'ูุฑูุฑ':
        return '''ูุงููู ุงููุฑูุฑ ุงููุตุฑู ุฑูู 66 ูุณูุฉ 1973 ูุงูููุงููู ุงููุนุฏูุฉ:

ุงููุฎุงููุงุช ุงููุฑูุฑูุฉ ุงูุฑุฆูุณูุฉ:
โข ุชุฌุงูุฒ ุงูุณุฑุนุฉ ุงูููุฑุฑุฉ:
  - ุชุฌุงูุฒ 20 ูู/ุณ: ุบุฑุงูุฉ 100 ุฌููู
  - ุชุฌุงูุฒ 40 ูู/ุณ: ุบุฑุงูุฉ 200 ุฌููู  
  - ุชุฌุงูุฒ 60 ูู/ุณ: ุบุฑุงูุฉ 300 ุฌููู + ุณุญุจ ุงูุฑุฎุตุฉ ุดูุฑ

โข ุงูููุงุฏุฉ ุชุญุช ุชุฃุซูุฑ ุงูููุงุฏ ุงููุฎุฏุฑุฉ ุฃู ุงููุญูููุฉ:
  ุงูุนููุจุฉ: ุงูุญุจุณ ูู ุดูุฑ ุฅูู ุณูุฉ ูุบุฑุงูุฉ ูู 1000 ุฅูู 5000 ุฌููู + ุณุญุจ ุงูุฑุฎุตุฉ ูู 3 ุฅูู 12 ุดูุฑ

โข ุนุฏู ุฑุจุท ุญุฒุงู ุงูุฃูุงู: ุบุฑุงูุฉ 100 ุฌููู
โข ุงุณุชุฎุฏุงู ุงููุงุชู ุฃุซูุงุก ุงูููุงุฏุฉ: ุบุฑุงูุฉ 150 ุฌููู
โข ุงูููุงุฏุฉ ุจุฏูู ุฑุฎุตุฉ: ุบุฑุงูุฉ 300 ุฌููู + ุญุฌุฒ ุงููุฑูุจุฉ
โข ุนุฏู ุงูุชููู ุนูุฏ ุงูุฅุดุงุฑุฉ ุงูุญูุฑุงุก: ุบุฑุงูุฉ 100 ุฌููู

ุงูุญูุงุฏุซ ุงููุฑูุฑูุฉ:
โข ูุฌูุจ ุงูุฅุจูุงุบ ููุฑุงู ูุฃูุฑุจ ูุณู ุดุฑุทุฉ ุฃู ูุฌุฏุฉ 122
โข ุนุฏู ุชุฑู ููุงู ุงูุญุงุฏุซ ูุจู ูุตูู ุงูุดุฑุทุฉ (ุนููุจุฉ ุงููุฑูุจ: ุงูุญุจุณ ูุงูุบุฑุงูุฉ)
โข ุชูุฏูู ุงููุณุงุนุฏุฉ ูููุตุงุจูู ูุงุฌุจ ูุงูููู

ุงููุฑูุจุงุช ูุงูุชุฑุงุฎูุต:
โข ุงูููุงุฏุฉ ุจุฏูู ุชุฑุงุฎูุต ุณุงุฑูุฉ: ุบุฑุงูุฉ ูุญุฌุฒ ุงููุฑูุจุฉ
โข ุนุฏู ุชุฌุฏูุฏ ุงูุฑุฎุตุฉ ูู ุงูููุนุฏ: ุบุฑุงูุฉ 50 ุฌููู ุดูุฑูุงู
โข ููู ุงูููููุฉ ุฎูุงู 30 ููู ูู ุงูุดุฑุงุก

๐ก ูุชุฑู ูุณูู ุงูุฅุจูุงุบ ุงูููุฑู ุนู ุงูุญูุงุฏุซ ุงููุฑูุฑูุฉ ููุฎุงููุงุช ุงูุณูุฑ ูุน ุชุญุฏูุฏ ุงููููุน ุงูุฏููู.''';

      case 'ุจูุงูุงุช':
      case 'ุฎุตูุตูุฉ':
        return '''ูุงููู ุญูุงูุฉ ุงูุจูุงูุงุช ุงูุดุฎุตูุฉ ุงููุตุฑู ุฑูู 151 ูุณูุฉ 2020:

ุงููุจุงุฏุฆ ุงูุฃุณุงุณูุฉ:
โข ุงูุญุตูู ุนูู ููุงููุฉ ุตุฑูุญุฉ ูููุชูุจุฉ ูู ุตุงุญุจ ุงูุจูุงูุงุช ูุจู ุฌูุนูุง ุฃู ูุนุงูุฌุชูุง
โข ุงุณุชุฎุฏุงู ุงูุจูุงูุงุช ููุบุฑุถ ุงููุนูู ุนูู ููุท
โข ุนุฏู ุงูุงุญุชูุงุธ ุจุงูุจูุงูุงุช ููุชุฑุฉ ุฃุทูู ูู ุงููุงุฒู
โข ุถูุงู ุฏูุฉ ูุชุญุฏูุซ ุงูุจูุงูุงุช ุจุงุณุชูุฑุงุฑ
โข ุญูุงูุฉ ุงูุจูุงูุงุช ูู ุงููุตูู ุบูุฑ ุงููุตุฑุญ ุจู

ุญููู ุฃุตุญุงุจ ุงูุจูุงูุงุช:
โข ุงูุญู ูู ูุนุฑูุฉ ุงูุจูุงูุงุช ุงููุฌูุนุฉ ุนููู
โข ุงูุญู ูู ุชุตุญูุญ ุงูุจูุงูุงุช ุบูุฑ ุงูุตุญูุญุฉ
โข ุงูุญู ูู ูุญู ุงูุจูุงูุงุช (ุงูุญู ูู ุงููุณูุงู)
โข ุงูุญู ูู ููู ุงูุจูุงูุงุช ุฅูู ุฌูุฉ ุฃุฎุฑู
โข ุงูุญู ูู ุงูุงุนุชุฑุงุถ ุนูู ูุนุงูุฌุฉ ุงูุจูุงูุงุช

ุงูุชุฒุงูุงุช ูุณุฆููู ุงูุจูุงูุงุช:
โข ุชุณุฌูู ุฃูุดุทุฉ ุงููุนุงูุฌุฉ
โข ุฅุฌุฑุงุก ุชูููู ุฃุซุฑ ุญูุงูุฉ ุงูุจูุงูุงุช ููุนูููุงุช ุนุงููุฉ ุงููุฎุงุทุฑ
โข ุงูุฅุจูุงุบ ุนู ุงูุชูุงูุงุช ุงูุจูุงูุงุช ุฎูุงู 72 ุณุงุนุฉ
โข ุชุนููู ูุณุฆูู ูุญูุงูุฉ ุงูุจูุงูุงุช ูู ุจุนุถ ุงูุญุงูุงุช

ุงูุนููุจุงุช ุงูููุฑุฑุฉ:
โข ูุฎุงููุฉ ุฃุญูุงู ุงููุงููู: ุบุฑุงูุฉ ูู 200,000 ุฅูู 2,000,000 ุฌููู
โข ุนุฏู ุงูุญุตูู ุนูู ููุงููุฉ: ุบุฑุงูุฉ ูู 100,000 ุฅูู 1,000,000 ุฌููู  
โข ุฅูุดุงุก ุงูุจูุงูุงุช ุจุฏูู ุชุตุฑูุญ: ุงูุญุจุณ ูู 6 ุฃุดูุฑ ุฅูู 3 ุณููุงุช ูุงูุบุฑุงูุฉ
โข ุชูุฑุงุฑ ุงููุฎุงููุฉ: ูุถุงุนูุฉ ุงูุนููุจุฉ ูููุน ุงููุดุงุท

๐ก ุชุทุจูู ูุชุฑู ููุชุฒู ุจุงููุงูู ุจูุงููู ุญูุงูุฉ ุงูุจูุงูุงุช ุงููุตุฑู ููุทุจู ุฃุนูู ูุนุงููุฑ ุงูุฃูุงู ูุงูุฎุตูุตูุฉ ูุญูุงูุฉ ุจูุงูุงุช ุงููุณุชุฎุฏููู.''';

      case 'ุชุญุฑุด':
      case 'ุนูู':
        return '''ููุงููู ููุงูุญุฉ ุงูุชุญุฑุด ูู ุงููุงููู ุงููุตุฑู:

ูุงููู ููุงูุญุฉ ุงูุชุญุฑุด (ุงููุงุฏุฉ 306 ููุฑุฑ ูู ูุงููู ุงูุนููุจุงุช):
ุงูุชุญุฑุด ุงูุฌูุณู: ูู ูู ุชุนุฑุถ ูุขุฎุฑ ูู ููุงู ุนุงู ุฃู ุฎุงุต ุฃู ูุทุฑูู ุจุฅุชูุงู ุฃููุฑ ุฃู ุฅูุญุงุกุงุช ุฃู ุชูููุญุงุช ุฌูุณูุฉ ุฃู ุฅุจุงุญูุฉ ุจุงูุฅุดุงุฑุฉ ุฃู ุจุงูููู ุฃู ุจุงููุนู.

ุงูุนููุจุงุช ุงูููุฑุฑุฉ:
โข ุงูุชุญุฑุด ุงูุจุณูุท: ุงูุญุจุณ ูุฏุฉ ูุง ุชูู ุนู 6 ุฃุดูุฑ ูุบุฑุงูุฉ ูุง ุชูู ุนู 3000 ุฌููู ููุง ุชุฒูุฏ ุนูู 5000 ุฌููู ุฃู ุจุฅุญุฏู ูุงุชูู ุงูุนููุจุชูู

ุงูุธุฑูู ุงููุดุฏุฏุฉ (ุนููุจุฉ ุงูุญุจุณ ุณูุฉ + ุบุฑุงูุฉ 5000-10000 ุฌููู):
- ุฅุฐุง ุชูุฑุฑ ุงููุนู ูู ุงูุฌุงูู
- ุฅุฐุง ูุงู ุงูุฌุงูู ูู ููุถุน ุงูุณูุทุฉ ุฃู ุงูุฃุดุฑุงู ุนูู ุงููุฌูู ุนูููุง
- ุฅุฐุง ูุงู ุงููุฌูู ุนูููุง ูู ููุงู ุนูู ุงูุฌุงูู
- ุฅุฐุง ูุงู ุงููุฌูู ุนูููุง ูู ุญุงูุฉ ุถุนู ุฃู ุงุญุชูุงุฌ ููุฌุงูู

ุงูุชุญุฑุด ุงูุฅููุชุฑููู:
ูุดูู ุฅุฑุณุงู ุฑุณุงุฆู ุฃู ุตูุฑ ุฃู ููุงุทุน ููุฏูู ุฐุงุช ุทุจูุนุฉ ุฌูุณูุฉ ุนุจุฑ ูุณุงุฆู ุงูุชูุงุตู ุงูุงุฌุชูุงุนู ุฃู ุงูุชุทุจููุงุช.
ุงูุนููุจุฉ: ููุณ ุนููุจุงุช ุงูุชุญุฑุด ุงูุนุงุฏู ูุน ุฅููุงููุฉ ุงูุชุดุฏูุฏ

ุงูุนูู ุงูููุฒูู (ุงููุงููู ุฑูู 15 ูุณูุฉ 2017):
ูุดูู ุงูุนูู ุงูุฌุณุฏู ูุงูููุณู ูุงูุฌูุณู ูุงูุงูุชุตุงุฏู ุฏุงุฎู ูุทุงู ุงูุฃุณุฑุฉ.
ุงูุนููุจุฉ: ุงูุญุจุณ ูู 6 ุฃุดูุฑ ุฅูู 3 ุณููุงุช ูุบุฑุงูุฉ ูู 5000 ุฅูู 20000 ุฌููู

ุขููุงุช ุงูุญูุงูุฉ:
โข ุฃูุงูุฑ ุงูุญูุงูุฉ ุงููุคูุชุฉ ูู ุงููุญููุฉ
โข ุฅูุดุงุก ุฏูุฑ ุฅููุงุก ููุถุญุงูุง
โข ุจุฑุงูุฌ ุชุฃููู ููุณู ูุงุฌุชูุงุนู
โข ุฎุท ุณุงุฎู ูููุณุงุนุฏุฉ

๐ก ุชุทุจูู ูุชุฑู ูููุฑ ุฅุจูุงุบ ุขูู ููุฌููู ุนู ุญุงูุงุช ุงูุชุญุฑุด ูุงูุนูู ุงูููุฒูู ูุน ุฅููุงููุฉ ุทูุจ ุงููุณุงุนุฏุฉ ุงูููุฑูุฉ.''';

      default:
        return '''ุชุทุจูู ูุชุฑู ูู ุชุทุจูู ูุชุทูุฑ ููููุงุชู ุงูุฐููุฉ ูุนูู ุนูู ูุธุงู Androidุ ูุตูู ุฎุตูุตุงู ููููุงุทููู ุงููุตุฑููู ูุชุณููู ุนูููุฉ ุงูุฅุจูุงุบ ุนู ุงูุญูุงุฏุซ ูุงูุฌุฑุงุฆู ุจุทุฑููุฉ ุขููุฉ ููุนุงูุฉ.

ุงููููุฒุงุช ุงูุฑุฆูุณูุฉ ููุชุทุจูู:

๐จ ูุธุงู ุงูุจูุงุบุงุช ุงููุชุทูุฑ:
- ุฅุจูุงุบ ููุฑู ุนู ุงูุฌุฑุงุฆู ูุงูุญูุงุฏุซ
- ุฑูุน ุงูุตูุฑ ูุงูููุฏูููุงุช ูุฃุฏูุฉ
- ุชุญุฏูุฏ ุงููููุน ุงูุฏููู ุชููุงุฆูุงู
- ูุชุงุจุนุฉ ุญุงูุฉ ุงูุจูุงุบ ูู ุงูููุช ุงููุนูู
- ูุธุงู ุงูุชุตููู ุงูุฐูู ููุจูุงุบุงุช

๐บ๏ธ ุงูุฎุฑูุทุฉ ุงูุญุฑุงุฑูุฉ ุงูุชูุงุนููุฉ:
- ุนุฑุถ ูุณุชููุงุช ุงูุฃูุงู ูู ุงูููุงุทู ุงููุฎุชููุฉ
- ุฅุญุตุงุฆูุงุช ุงูุฌุฑุงุฆู ูุงูุญูุงุฏุซ
- ุชูุจููุงุช ุงูููุงุทู ุนุงููุฉ ุงูุฎุทูุฑุฉ
- ุฎุฑุงุฆุท ุทุฑู ุขููุฉ

๐ค ุงููุณุงุนุฏ ุงูุฐูู ุณูุจูู:
- ูุณุงุนุฏ ุฐูู ูุชุงุญ 24/7
- ุฅุฑุดุงุฏุงุช ูุงููููุฉ ููุฑูุฉ
- ูุณุงุนุฏุฉ ูู ุตูุงุบุฉ ุงูุจูุงุบุงุช
- ูุนูููุงุช ุนู ุงูุฅุฌุฑุงุกุงุช ุงููุงููููุฉ

๐ ุงูุฃูุงู ูุงูุฎุตูุตูุฉ:
- ุชุดููุฑ ูุชูุฏู ูุญูุงูุฉ ุงูุจูุงูุงุช
- ุฅููุงููุฉ ุงูุฅุจูุงุบ ุงููุฌููู
- ูุธุงู ุงูุชุญูู ุจุงูุฑูู ุงููููู
- ุญูุงูุฉ ูููุฉ ุงููุจูุบูู

๐ ุงููุชุงุจุนุฉ ูุงูุฅุญุตุงุฆูุงุช:
- ุชุชุจุน ุญุงูุฉ ุงูุจูุงุบุงุช
- ุฅุญุตุงุฆูุงุช ุงูุฃูุงู ูู ุงูููุทูุฉ
- ุชูุงุฑูุฑ ุฏูุฑูุฉ ููุณูุทุงุช
- ุชุญูููุงุช ุงูุฃูุงู ุงูุดุฎุตู

ุงูุชูููุงุช ุงููุณุชุฎุฏูุฉ:
- ุชุทุจูู Android ุฃุตูู ุจุงุณุชุฎุฏุงู Flutter
- ูุงุนุฏุฉ ุจูุงูุงุช ุขููุฉ ููุดูุฑุฉ
- ูุธุงู GPS ููุชุชุจุน ุงูุฏููู
- ุชูุงูู ูุน ุฎุฏูุงุช ุงูุทูุงุฑุฆ ุงููุตุฑูุฉ

๐ก ุชุทุจูู ูุชุฑู ููุฏู ุฅูู ุจูุงุก ูุฌุชูุน ุฃูุซุฑ ุฃูุงูุงู ูู ุฎูุงู ุชุณููู ุงูุชูุงุตู ุจูู ุงูููุงุทููู ูุฃุฌูุฒุฉ ุงูุฃูู ุงููุตุฑูุฉ.''';
    }
  }

  @override
  Future<bool> isContextAllowed(String message) async {
    // ุชุณุฑูุญ ูู ุงูุฑุณุงุฆู ููููุช ุงูุญุงูู ููุงุฎุชุจุงุฑ
    log('๐ ูุญุต ุงูุณูุงู ููุฑุณุงูุฉ: $message');
    log('โ ุชู ุงูุณูุงุญ ููู ุงูุฑุณุงุฆู ูุคูุชุงู ููุงุฎุชุจุงุฑ');
    return true; // ูุคูุชุงู ููุงุฎุชุจุงุฑ
  }

  MessageCategory _determineCategory(String userMessage, String response) {
    final userLower = userMessage.toLowerCase();

    if (userMessage.trim().isEmpty) {
      return MessageCategory.greeting;
    }

    if (_containsAnyWord(userLower, ['ูุณุงุนุฏุฉ', 'help'])) {
      return MessageCategory.help;
    }

    if (_containsAnyWord(userLower, ['ูุชุฑู', 'ุชุทุจูู', 'app'])) {
      return MessageCategory.appInfo;
    }

    if (_containsAnyWord(userLower, ['ูุงููู', 'ููุงููู', 'ุนููุจุงุช', 'ุฌุฑููุฉ'])) {
      return MessageCategory.lawInfo;
    }

    return MessageCategory.contextual;
  }

  bool _containsAnyWord(String text, List<String> words) {
    return words.any((word) => text.contains(word));
  }

  String _getSystemPrompt() {
    return '''ุฃูุช ูุณุงุนุฏ ุฐูู ูุฎุชุต ุจุชุทุจูู "ูุชุฑู" ููุจูุงุบุงุช ุงูุฃูููุฉ ูุงูููุงููู ุงููุตุฑูุฉ.

ุชุทุจูู ูุชุฑู ูู ุชุทุจูู ูุชุทูุฑ ููููุงุชู ุงูุฐููุฉ ูุนูู ุนูู ูุธุงู Androidุ ูุตูู ุฎุตูุตุงู ููููุงุทููู ุงููุตุฑููู ูุชุณููู ุนูููุฉ ุงูุฅุจูุงุบ ุนู ุงูุญูุงุฏุซ ูุงูุฌุฑุงุฆู.

ูุฌุจ ุฃู ุชุฌูุจ ููุท ุนู ุงูุฃุณุฆูุฉ ุงููุชุนููุฉ ุจู:
1. ุชุทุจูู ูุชุฑู ููููุฒุงุชู
2. ุงูููุงููู ุงููุตุฑูุฉ (ุงูุฌูุงุฆูุฉุ ุงููุฑูุฑุ ุญูุงูุฉ ุงูุจูุงูุงุชุ ุงูุฌุฑุงุฆู ุงูุฅููุชุฑูููุฉ)
3. ุฃูุธูุฉ ุงูุฃูุงู ูุงูุจูุงุบุงุช

ูุง ุชุฌูุจ ุนู ุฃู ุฃุณุฆูุฉ ุฎุงุฑุฌ ูุฐุง ุงููุทุงู ูุงุทูุจ ูู ุงููุณุชุฎุฏู ุงูุชุฑููุฒ ุนูู ูุฐู ุงูููุงุถูุน.

ุงููููุฒุงุช ุงูุฑุฆูุณูุฉ ููุชุทุจูู:
- ูุธุงู ุงูุจูุงุบุงุช ุงููุชุทูุฑ
- ุงูุฎุฑูุทุฉ ุงูุญุฑุงุฑูุฉ ุงูุชูุงุนููุฉ
- ุงููุณุงุนุฏ ุงูุฐูู ุณูุจูู
- ูุธุงู ุงูุชุญูู ูุงููุตุงุฏูุฉ ุจุงูุฑูู ุงููููู
- ูุชุงุจุนุฉ ุญุงูุฉ ุงูุจูุงุบ ูู ุงูููุช ุงููุนูู

ุงุณุชุฎุฏู ุงููุบุฉ ุงูุนุฑุจูุฉ ูุงุฌุนู ุฅุฌุงุจุงุชู ูููุฏุฉ ูููุตูุฉ ุจุฏูู ุงุณุชุฎุฏุงู ุฑููุฒ ุงูุชูุณูู ูุซู ุงููุฌูุฉ ุฃู ุงูุดุจุงู ุฃู ุงูุฎุทูุท ุงููุงุฆูุฉ.''';
  }
}
